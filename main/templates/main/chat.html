<!-- Enhanced Chatbot Section -->
<section class="section" id="chatbot">
    <div class="container">
        <h2 class="section-title fade-in">AI Assistant</h2>
        <p class="section-subtitle fade-in">Ask me anything about my work, skills, or experience</p>
        
        <div class="chatbot-container" style="
            max-width: 700px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            animation: fadeInUp 0.8s ease-out 0.3s both;
        ">
            <!-- Chat Header -->
            <div class="chat-header" style="
                padding: 1.5rem 2rem;
                background: var(--gradient-primary);
                color: white;
                display: flex;
                align-items: center;
                gap: 1rem;
            ">
                <div style="
                    width: 50px;
                    height: 50px;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.5rem;
                    backdrop-filter: blur(10px);
                ">
                    <i class='bx bx-bot'></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600;">Portfolio Assistant</h3>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Always here to help</p>
                </div>
                <div style="margin-left: auto;">
                    <div style="
                        width: 12px;
                        height: 12px;
                        background: #4ade80;
                        border-radius: 50%;
                        animation: pulse 2s infinite;
                    "></div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-messages" style="
                min-height: 300px;
                max-height: 400px;
                overflow-y: auto;
                padding: 2rem;
                background: var(--bg-secondary);
                display: flex;
                flex-direction: column;
                gap: 1rem;
            ">
                <!-- Welcome Message -->
                <div class="message bot-message" style="
                    display: flex;
                    align-items: flex-start;
                    gap: 0.75rem;
                    animation: slideInLeft 0.5s ease-out;
                ">
                    <div style="
                        width: 40px;
                        height: 40px;
                        background: var(--accent-color);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 1.2rem;
                        flex-shrink: 0;
                    ">
                        <i class='bx bx-bot'></i>
                    </div>
                    <div style="
                        background: var(--bg-card);
                        padding: 1rem 1.5rem;
                        border-radius: 1rem 1rem 1rem 0.25rem;
                        color: var(--text-primary);
                        max-width: 80%;
                        box-shadow: var(--shadow-light);
                        border: 1px solid var(--border-color);
                    ">
                        <p style="margin: 7px; line-height: 1.5;">
                            Hello! I'm your AI assistant. Feel free to ask me about Abdullah's projects, skills, experience, or anything else you'd like to know!
                        </p>
                    </div>
                </div>

                <!-- Dynamic Messages Container -->
                <div id="chatResponse"></div>
            </div>

            <!-- Chat Input Area -->
            <div class="chat-input" style="
                padding: 1.5rem 2rem;
                background: var(--bg-card);
                border-top: 1px solid var(--border-color);
            ">
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; position: relative;">
                        <textarea 
                            id="userInput" 
                            placeholder="Type your message here..." 
                            rows="1"
                            style="
                                width: 100%;
                                min-height: 50px;
                                max-height: 120px;
                                padding: 0.875rem 1rem;
                                background: var(--bg-secondary);
                                border: 2px solid var(--border-color);
                                border-radius: 1rem;
                                color: #0B3656;
                                font-size: 1rem;
                                font-family: inherit;
                                resize: none;
                                transition: all 0.3s ease;
                                outline: none;
                            "
                            onkeypress="handleKeyPress(event)"
                            onfocus="this.style.borderColor='var(--accent-color)'; this.style.boxShadow='0 0 0 3px rgba(187, 152, 117, 0.1)'"
                            onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <button 
                        id="sendBtn" 
                        onclick="sendMessage()" 
                        style="
                            width: 50px;
                            height: 50px;
                            background: var(--gradient-primary);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 1.3rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.3s ease;
                            flex-shrink: 0;
                        "
                        onmouseover="this.style.transform='translateY(-2px) scale(1.05)'"
                        onmouseout="this.style.transform='translateY(0) scale(1)'"
                    >
                        <i class='bx bx-send'></i>
                    </button>
                </div>

                <!-- Audio Player -->
                <audio id="audioPlayer" controls style="
                    display: none; 
                    margin-top: 1rem; 
                    width: 100%; 
                    border-radius: 0.5rem;
                    height: 40px;
                "></audio>

                <!-- Quick Actions -->
                <div class="quick-actions" style="
                    display: flex;
                    gap: 0.5rem;
                    margin-top: 1rem;
                    flex-wrap: wrap;
                ">
                    <button onclick="insertQuickMessage('Tell me about your projects')" class="quick-btn">
                        Projects
                    </button>
                    <button onclick="insertQuickMessage('What are your skills?')" class="quick-btn">
                        Skills
                    </button>
                    <button onclick="insertQuickMessage('Tell me about your experience')" class="quick-btn">
                        Experience
                    </button>
                    <button onclick="insertQuickMessage('What certifications do you have?')" class="quick-btn">
                        Certifications
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Quick Action Buttons */
.quick-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.quick-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
    transform: translateY(-1px);
}

/* Message Animations */
@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Scrollbar Styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: var(--accent-hover);
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-header {
        padding: 1rem 1.5rem !important;
    }
    
    .chat-messages {
        padding: 1.5rem !important;
        min-height: 250px !important;
        max-height: 300px !important;
    }
    
    .chat-input {
        padding: 1rem 1.5rem !important;
    }
    
    .quick-actions {
        gap: 0.375rem !important;
    }
    
    .quick-btn {
        font-size: 0.8rem !important;
        padding: 0.4rem 0.8rem !important;
    }
}
</style>

<script>
// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Handle Enter key press
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// Insert quick message
function insertQuickMessage(message) {
    document.getElementById('userInput').value = message;
    document.getElementById('userInput').focus();
}

// Enhanced send message function
async function sendMessage() {
    const textarea = document.getElementById("userInput");
    const text = textarea.value.trim();
    const responseDiv = document.getElementById("chatResponse");
    const audioPlayer = document.getElementById("audioPlayer");
    const sendBtn = document.getElementById("sendBtn");

    if (!text) return;

    // Add user message to chat
    const userMessage = document.createElement('div');
    userMessage.className = 'message user-message';
    userMessage.style.cssText = `
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        justify-content: flex-end;
        animation: slideInRight 0.3s ease-out;
    `;
    userMessage.innerHTML = `
        <div style="
            background: var(--gradient-primary);
            padding: 1rem 1.5rem;
            border-radius: 1rem 1rem 0.25rem 1rem;
            color: white;
            max-width: 80%;
            box-shadow: var(--shadow-light);
        ">
            <p style="margin: 7px; line-height: 1.5;">${text}</p>
        </div>
        <div style="
            width: 40px;
            height: 40px;
            background: var(--text-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        ">
            <i class='bx bx-user'></i>
        </div>
    `;
    responseDiv.appendChild(userMessage);

    // Clear input and disable button
    textarea.value = '';
    autoResize(textarea);
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="bx bx-loader-alt" style="animation: spin 1s linear infinite;"></i>';

    // Add loading message
    const loadingMessage = document.createElement('div');
    loadingMessage.className = 'message bot-message loading';
    loadingMessage.style.cssText = `
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        animation: slideInLeft 0.3s ease-out;
    `;
    loadingMessage.innerHTML = `
        <div style="
            width: 40px;
            height: 40px;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        ">
            <i class='bx bx-bot'></i>
        </div>
        <div style="
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 1rem 1rem 1rem 0.25rem;
            color: var(--text-primary);
            max-width: 80%;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        ">
            <div style="
                width: 8px;
                height: 8px;
                background: var(--accent-color);
                border-radius: 50%;
                animation: pulse 1.5s infinite;
            "></div>
            <div style="
                width: 8px;
                height: 8px;
                background: var(--accent-color);
                border-radius: 50%;
                animation: pulse 1.5s infinite 0.2s;
            "></div>
            <div style="
                width: 8px;
                height: 8px;
                background: var(--accent-color);
                border-radius: 50%;
                animation: pulse 1.5s infinite 0.4s;
            "></div>
        </div>
    `;
    responseDiv.appendChild(loadingMessage);

    // Scroll to bottom
    const messagesContainer = document.querySelector('.chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    try {
        const response = await fetch("/chatbot/chat/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
        });

        const data = await response.json();

        // Remove loading message
        loadingMessage.remove();

        // Add bot response
        const botMessage = document.createElement('div');
        botMessage.className = 'message bot-message';
        botMessage.style.cssText = `
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideInLeft 0.3s ease-out;
        `;

        if (data.error) {
            botMessage.innerHTML = `
                <div style="
                    width: 40px;
                    height: 40px;
                    background: #ef4444;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 1rem;
                    flex-shrink: 0;
                ">
                    <i class='bx bx-error'></i>
                </div>
                <div style="
                    background: rgba(239, 68, 68, 0.1);
                    border: 1px solid rgba(239, 68, 68, 0.3);
                    padding: 1rem 1.5rem;
                    border-radius: 1rem 1rem 1rem 0.25rem;
                    color: #ef4444;
                    max-width: 80%;
                ">
                    <p style="margin: 7px ; line-height: 1.5;">Sorry, I encountered an error: ${data.error}</p>
                </div>
            `;
        } else {
            botMessage.innerHTML = `
                <div style="
                    width: 40px;
                    height: 40px;
                    background: var(--accent-color);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 1.2rem;
                    flex-shrink: 0;
                ">
                    <i class='bx bx-bot'></i>
                </div>
                <div style="
                    background: var(--bg-card);
                    padding: 1rem 1.5rem;
                    border-radius: 1rem 1rem 1rem 0.25rem;
                    color: var(--text-primary);
                    max-width: 80%;
                    box-shadow: var(--shadow-light);
                    border: 1px solid var(--border-color);
                ">
                    <p style="margin: 7px; line-height: 1.5;">${data.response}</p>
                </div>
            `;
            
            if (data.audio_file_url) {
                audioPlayer.src = data.audio_file_url;
                audioPlayer.style.display = "block";
                audioPlayer.play();
            }
        }
        
        responseDiv.appendChild(botMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } catch (err) {
        // Remove loading message
        loadingMessage.remove();
        
        const errorMessage = document.createElement('div');
        errorMessage.className = 'message bot-message';
        errorMessage.style.cssText = `
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideInLeft 0.3s ease-out;
        `;
        errorMessage.innerHTML = `
            <div style="
                width: 40px;
                height: 40px;
                background: #ef4444;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.2rem;
                flex-shrink: 0;
            ">
                <i class='bx bx-error'></i>
            </div>
            <div style="
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                padding: 1rem 1.5rem;
                border-radius: 1rem 1rem 1rem 0.25rem;
                color: #ef4444;
                max-width: 80%;
            ">
                <p style="margin: 7px; line-height: 1.5;">Connection error. Please try again.</p>
            </div>
        `;
        responseDiv.appendChild(errorMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bx bx-send"></i>';
        textarea.focus();
    }
}

// Add spinning animation for loading
const style = document.createElement('style');
style.textContent = '@keyframes spin { 100% { transform: rotate(360deg); } }';
document.head.appendChild(style);
</script>